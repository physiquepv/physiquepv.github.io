<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Cartes M√©moire Avanc√©es</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&family=Orbitron:wght@400;700&family=Merienda:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --grid-color: rgba(100, 255, 218, 0.07);
            --pastel-color-light-1: #E6E6FA;
            --pastel-color-light-2: #D8BFD8;
            --pastel-color-dark-1: #5F4B8B;
            --pastel-color-dark-2: #9A7FB0;
        }

        .glassmorphism {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .light-mode-card-neutral {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #374151;
        }
        .dark-mode-card-neutral {
            background: rgba(55, 65, 81, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #f3f4f6;
        }

        .glassmorphism-menu {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.light-mode .glassmorphism-menu {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .glassmorphism-menu {
            background: rgba(17, 24, 39, 0.92);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .card-translation { color: #2563eb; }
        body.dark-mode .card-translation { color: #60a5fa; }

        .search-results-container::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        body.dark-mode .search-results-container::-webkit-scrollbar-thumb {
            background-color: rgba(75, 85, 99, 0.7);
        }
        .search-results-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }

        .menu-slide-in { transform: translateX(0%); transition: transform 0.3s ease-out; }
        .menu-slide-out { transform: translateX(-100%); transition: transform 0.3s ease-in; }
        #sidebar-menu { will-change: transform; }

        .chapter-button-active {
            background-color: #F59E0B;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }
        body.dark-mode .chapter-button-active {
            background-color: #FBBF24;
            color: #1f2937 !important;
        }

        body { transition: background-color 0.5s, color 0.5s, background-image 0.5s, font-family 0.5s; touch-action: pan-y; }
        body.light-mode { background-color: #f3f4f6; color: #111827; }
        body.dark-mode { background-color: #111827; color: #f9fafb; }

        body.light-mode input[type="text"],
        body.light-mode select {
            background-color: #ffffff;
            color: #111827;
            border-color: #d1d5db;
        }
        body.light-mode input[type="text"]::placeholder { color: #6b7280; }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background-color: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }
        body.dark-mode input[type="text"]::placeholder { color: #9ca3af; }
        body.dark-mode select option { background-color: #1f2937; color: #f9fafb; }
        body.dark-mode select { color: #f9fafb !important; }
        body.light-mode select { color: #111827 !important; }

        body.light-mode #burger-button { background-color: rgba(255, 255, 255, 0.85); color: #374151; }
        body.dark-mode #burger-button { background-color: rgba(30, 41, 59, 0.85); color: #e5e7eb; }

        body.light-mode .chapter-button-default {
            background-color: #ffffff;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        body.dark-mode .chapter-button-default {
            background-color: #374151;
            color: #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        body.light-mode #card-score { background-color: rgba(0, 0, 0, 0.05); color: #374151; }
        body.dark-mode #card-score { background-color: rgba(255, 255, 255, 0.1); color: #e5e7eb; }
        body.light-mode .bg-white\/50 { background-color: rgba(255, 255, 255, 0.8); }
        body.dark-mode .bg-white\/50 { background-color: rgba(30, 41, 59, 0.8); }
        body.light-mode .bg-gray-300 { background-color: #e5e7eb; }
        body.dark-mode .bg-gray-700 { background-color: #374151; }

        .sci-fi-grid-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
            opacity: 0; transition: opacity 0.5s;
        }

        @keyframes pastelGradientFlowLight { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes pastelGradientFlowDark  { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        body.theme-pastel.light-mode {
            background: linear-gradient(to right, var(--pastel-color-light-1), var(--pastel-color-light-2), var(--pastel-color-light-1));
            background-size: 200% 100%;
            animation: pastelGradientFlowLight 20s linear infinite;
        }
        body.theme-pastel.dark-mode {
            background: linear-gradient(to right, var(--pastel-color-dark-1), var(--pastel-color-dark-2), var(--pastel-color-dark-1));
            background-size: 200% 100%;
            animation: pastelGradientFlowDark 20s linear infinite;
        }

        @keyframes twinkling {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .star {
            position: absolute;
            width: var(--star-size); height: var(--star-size);
            background-color: var(--star-color);
            border-radius: 50%;
            opacity: 0.7;
            z-index: -1;
            transition: opacity 0.8s ease;
        }

        @media (prefers-reduced-motion: reduce) {
            body.theme-pastel { animation: none !important; }
            .star { transition: none !important; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 overflow-x-hidden pt-20">
    <div id="animated-bg-elements" class="fixed top-0 left-0 w-full h-full pointer-events-none overflow-hidden">
        <div class="sci-fi-grid-overlay"></div>
    </div>

    <button id="burger-button" class="fixed top-4 left-4 z-30 p-2 backdrop-blur-sm rounded-md shadow-lg text-lg">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-72 sm:w-80 glassmorphism-menu shadow-2xl p-6 z-40 menu-slide-out overflow-y-auto">
        <button id="close-menu-button" class="absolute top-4 right-4 text-xl p-1 hover:text-red-500 transition-colors">
            <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-6">Menu</h2>

        <div class="mb-4">
            <input type="text" id="search-bar" placeholder="Rechercher une carte..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-emerald-500 outline-none text-sm sm:text-base">
            <div id="search-results-container" class="search-results-container mt-2 max-h-32 overflow-y-auto text-sm"></div>
        </div>

        <div class="mb-4">
            <h3 id="chapters-title" class="text-lg font-medium mb-2">Chapitres</h3>
            <div id="menu-chapters" class="space-y-2"></div>
        </div>

        <div class="mb-4 flex items-center justify-between">
            <label id="dark-mode-label" for="dark-mode-toggle" class="text-lg">Mode Sombre</label>
            <button id="dark-mode-toggle" class="p-2 rounded-md"><i class="fas fa-moon"></i></button>
        </div>

        <div class="mb-4 space-y-2">
            <button id="save-data-button" class="w-full p-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-md transition-colors"><i class="fas fa-save mr-2"></i>Sauvegarder</button>
            <label id="load-data-label" class="w-full p-2 bg-sky-500 hover:bg-sky-600 text-white rounded-md transition-colors cursor-pointer flex items-center justify-center">
                <i class="fas fa-upload mr-2"></i><span id="load-data-label-text">Charger</span>
                <input type="file" id="load-data-input" accept=".json" class="hidden">
            </label>
        </div>

        <div>
            <h3 id="reset-title" class="text-lg font-medium mb-2">R√©initialiser</h3>
            <select id="reset-options" class="w-full p-2 border rounded-md mb-2"></select>
            <button id="reset-data-button" class="w-full p-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors"><i class="fas fa-undo mr-2"></i>R√©initialiser S√©lection</button>
        </div>

        <div class="mt-6">
            <button id="reverse-mode-button" class="w-full p-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md transition-colors">
                <i class="fas fa-exchange-alt mr-2"></i>Inverser FR ‚Üî EN
            </button>
        </div>
    </div>

    <div class="w-full max-w-2xl mx-auto flex flex-col items-center space-y-3 sm:space-y-4 relative z-10">
        <!-- √âtiquette discr√®te du chapitre actuel -->
        <div id="current-chapter-label" class="text-[11px] sm:text-xs uppercase tracking-wide text-gray-600 dark:text-gray-300 opacity-60 select-none -mb-1"></div>

        <div id="timer" class="font-mono text-xl sm:text-2xl p-2 bg-white/50 backdrop-blur-sm rounded-md shadow">00:00:00</div>

        <div class="w-full p-1 bg-white/50 backdrop-blur-sm rounded-md shadow">
            <div class="flex justify-between text-xs sm:text-sm mb-1 px-1">
                <span id="progress-text">Cartes vues: 0 / 0</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-2.5 sm:h-3">
                <div id="progress-bar-fill" class="bg-emerald-500 h-2.5 sm:h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <div id="flashcard-container" class="w-full min-h-[20rem] sm:min-h-[24rem] flex-grow p-6 rounded-xl shadow-xl flex flex-col justify-between items-center text-center cursor-pointer glassmorphism">
            <div class="w-full flex justify-end">
                <span id="card-score" class="text-lg sm:text-xl font-bold px-3 py-1 rounded-lg">50%</span>
            </div>
            <div id="card-content" class="flex-grow flex flex-col justify-center items-center">
                <p id="card-french-word" class="text-2xl sm:text-3xl md:text-4xl font-semibold"></p>
                <p id="card-english-word" class="text-xl sm:text-2xl md:text-3xl font-medium card-translation hidden"></p>
            </div>
            <div class="h-6"></div>
        </div>

        <div id="message-area" class="w-full text-center h-6 text-sm font-medium"></div>

        <div class="w-full flex flex-col sm:flex-row items-center gap-2 p-3 bg-white/50 backdrop-blur-sm rounded-lg shadow">
            <input type="text" id="answer-input" placeholder="Votre r√©ponse en anglais..." class="flex-grow p-3 border rounded-md focus:ring-2 focus:ring-emerald-500 outline-none text-base" autocorrect="off" autocapitalize="off" spellcheck="false">
            <button id="submit-answer-button" class="w-full sm:w-auto px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-md transition-colors text-sm sm:text-base">
                Valider
            </button>
        </div>
    </div>

    <script>
        // --- APPLICATION STATE ---
        let appState = {
            allCards: [],
            currentDeck: [],
            currentIndex: 0,
            currentChapter: 'Tout',
            timerInterval: null,
            elapsedSeconds: 0,
            darkMode: false,
            seenCountInSession: 0,
            isCardRevealedByClick: false,
            readyToAdvanceOnClick: false,
            currentTheme: 'default',
            searchIndex: null,
            reverseMode: false,
            uiLang: 'fr'
        };
        const i18n = {
          fr: {
            searchPlaceholder: 'Rechercher une carte...',
            chapters: 'Chapitres',
            darkMode: 'Mode Sombre',
            save: 'Sauvegarder',
            load: 'Charger',
            reset: 'R√©initialiser',
            resetSelection: 'R√©initialiser S√©lection',
            reverseButton: 'Inverser FR ‚Üî EN',
            themes: 'Th√®mes',
            themeDefault: 'D√©faut',
            themePastel: 'Pastel (√âvolutif)',
            themeGalaxy: 'Galaxie (√âtoiles)',
            all: 'Tout',
            cardsViewed: 'Cartes vues',
            answerPlaceholder_en: 'Votre r√©ponse en anglais...',
            answerPlaceholder_fr: 'Votre r√©ponse en fran√ßais...',
            noCard: 'Aucune carte √† afficher.',
            correct: 'Bonne r√©ponse !',
            incorrect: 'Incorrect.',
            endOfDeck: 'Fin du paquet ! R√©organisation...',
            noResult: 'Aucun r√©sultat',
            dataSaved: 'Donn√©es sauvegard√©es !',
            dataLoaded: 'Donn√©es charg√©es !',
            dataLoadError: 'Erreur lors du chargement des donn√©es.',
            resetConfirm: '√ätes-vous s√ªr de vouloir r√©initialiser les scores pour "{chapter}" ? Cette action est irr√©versible.',
            resetDone: 'Scores pour "{chapter}" r√©initialis√©s.',
            submit: 'Valider'
          },
          en: {
            searchPlaceholder: 'Search for a card...',
            chapters: 'Chapters',
            darkMode: 'Dark mode',
            save: 'Save',
            load: 'Load',
            reset: 'Reset',
            resetSelection: 'Reset selection',
            reverseButton: 'Reverse FR ‚Üî EN',
            themes: 'Themes',
            themeDefault: 'Default',
            themePastel: 'Pastel (Animated)',
            themeGalaxy: 'Galaxy (Stars)',
            all: 'All',
            cardsViewed: 'Cards viewed',
            answerPlaceholder_en: 'Your answer in English...',
            answerPlaceholder_fr: 'Your answer in French...',
            noCard: 'No card to display.',
            correct: 'Correct!',
            incorrect: 'Incorrect.',
            endOfDeck: 'End of deck! Reorganizing...',
            noResult: 'No results',
            dataSaved: 'Data saved!',
            dataLoaded: 'Data loaded!',
            dataLoadError: 'Error while loading data.',
            resetConfirm: 'Are you sure you want to reset scores for "{chapter}"? This action is irreversible.',
            resetDone: 'Scores for "{chapter}" reset.',
            submit: 'Submit'
          }
        };
        function t(key) {
          const lang = appState.uiLang || 'fr';
          return (i18n[lang] && i18n[lang][key]) || key;
        }
        function tr(key, vars = {}) {
          let s = t(key);
          Object.keys(vars).forEach(k => {
            s = s.replace(new RegExp(`\\{${k}\\}`, 'g'), vars[k]);
          });
          return s;
        }

        // --- INITIAL DATA (Sample) ---
        const initialCardsData = [
          { id: '0', french: "monarchie", english: "monarchy", chapter: 'Democracy', score: 50 },
          { id: '1', french: "monarque de droit divin", english: "a monarch by divine right", chapter: 'Democracy', score: 50 },
          { id: '2', french: "souverain", english: "sovereign", chapter: 'Democracy', score: 50 },
          { id: '3', french: "aristocratie", english: "aristocracy", chapter: 'Democracy', score: 50 },
          { id: '4', french: "oligarchie", english: "oligarchy", chapter: 'Democracy', score: 50 }
        ];

        const chapters = [
            { name: 'Democracy', emoji: 'üèõÔ∏è' },
            { name: 'Genetics', emoji: 'üß¨' },
            { name: 'Immigration', emoji: '‚úàÔ∏è' },
            { name: 'International Tensions', emoji: 'üåç' },
            { name: 'Unemployment', emoji: 'üìâ' },
            { name: 'Thanksgiving', emoji: 'ü¶É' },
            { name: 'Business', emoji: 'üíº' },
            { name: 'Politique', emoji: 'üó≥Ô∏è' },
            { name: 'Education', emoji: 'üéì' }
        ];
        const scoreLevels = [0, 16, 33, 50, 66, 84, 100];

        // --- UI SELECTORS ---
        const animatedBgElementsContainer = document.getElementById('animated-bg-elements');
        const timerEl = document.getElementById('timer');
        const progressTextEl = document.getElementById('progress-text');
        const progressPercentageEl = document.getElementById('progress-percentage');
        const progressBarFillEl = document.getElementById('progress-bar-fill');
        const menuChaptersContainerEl = document.getElementById('menu-chapters');

        const flashcardContainerEl = document.getElementById('flashcard-container');
        const cardScoreEl = document.getElementById('card-score');
        const cardFrenchWordEl = document.getElementById('card-french-word');
        const cardEnglishWordEl = document.getElementById('card-english-word');

        const messageAreaEl = document.getElementById('message-area');
        const answerInputEl = document.getElementById('answer-input');
        const submitAnswerButtonEl = document.getElementById('submit-answer-button');

        const burgerButtonEl = document.getElementById('burger-button');
        const sidebarMenuEl = document.getElementById('sidebar-menu');
        const closeMenuButtonEl = document.getElementById('close-menu-button');
        const searchBarEl = document.getElementById('search-bar');
        const searchResultsContainerEl = document.getElementById('search-results-container');
        const darkModeToggleEl = document.getElementById('dark-mode-toggle');
        const saveDataButtonEl = document.getElementById('save-data-button');
        const loadDataInputEl = document.getElementById('load-data-input');
        const resetOptionsEl = document.getElementById('reset-options');
        const resetDataButtonEl = document.getElementById('reset-data-button');
        const reverseModeButtonEl = document.getElementById('reverse-mode-button');
        const currentChapterLabelEl = document.getElementById('current-chapter-label');
        let themeSelectorEl;

        // --- THEME APPLICATION ---
        function applyCardThemeStyles() {
            flashcardContainerEl.style.backgroundColor = '';
            flashcardContainerEl.style.borderColor = '';
            flashcardContainerEl.style.color = '';

            let mainFont = "'Inter', sans-serif";
            let cardFont = mainFont;
            let timerFont = "'Roboto Mono', monospace";

            document.body.style.fontFamily = mainFont;
            cardFrenchWordEl.style.fontFamily = cardFont;
            cardEnglishWordEl.style.fontFamily = cardFont;
            timerEl.style.fontFamily = timerFont;
        }

        function updateUIForReverseMode() {
            appState.uiLang = appState.reverseMode ? 'en' : 'fr';
            const placeholderKey = appState.reverseMode ? 'answerPlaceholder_fr' : 'answerPlaceholder_en';
            answerInputEl.placeholder = t(placeholderKey);

            cardEnglishWordEl.classList.toggle('card-translation', !appState.reverseMode);
            cardFrenchWordEl.classList.toggle('card-translation', appState.reverseMode);

            if (reverseModeButtonEl) {
                reverseModeButtonEl.innerHTML = `<i class="fas fa-exchange-alt mr-2"></i>${t('reverseButton')}`;
            }

            updateLocalizedStaticTexts();
            renderProgressBar();
        }

        function applyTheme(themeName) {
            const setCssVar = (varName, value) => document.documentElement.style.setProperty(varName, value);
            appState.currentTheme = themeName;

            document.body.classList.remove('theme-pastel');
            if (themeName === 'pastel') document.body.classList.add('theme-pastel');

            if (themeName === 'pastel') {
                setCssVar('--pastel-color-light-1', '#E6E6FA');
                setCssVar('--pastel-color-light-2', '#D8BFD8');
                setCssVar('--pastel-color-dark-1', '#5F4B8B');
                setCssVar('--pastel-color-dark-2', '#9A7FB0');
            }

            clearAnimatedParticles('star');
            stopStarTwinkleLoop();
            if (themeName === 'default' && appState.darkMode) {
                createAnimatedParticles(100, 'star');
                startStarTwinkleLoop();
            }

            applyCardThemeStyles();
            localStorage.setItem('flashcardAppTheme', themeName);
            renderCard(false);
            updateActiveChapterButtonStates();
        }

        function createAnimatedParticles(count, type) {
            const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reduce) return;

            clearAnimatedParticles(type);
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '-1';
                particle.style.opacity = '0.7';

                if (type === 'star') {
                    const size = Math.random() * 2 + 1;
                    particle.style.setProperty('--star-size', `${size}px`);
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.left = `${Math.random() * 100}%`;
                    const starColors = appState.darkMode ? ['#E0E0FF', '#C4C4FF', '#A8A8FF'] : ['#CCCCFF', '#B0B0FF', '#9494FF'];
                    particle.style.setProperty('--star-color', starColors[Math.floor(Math.random() * starColors.length)]);
                    particle.style.borderRadius = '50%';
                    particle.classList.add('star');
                }
                animatedBgElementsContainer.appendChild(particle);
            }
        }

        let starTwinkleTimer = null;
        function startStarTwinkleLoop() {
            const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reduce) return;

            stopStarTwinkleLoop();
            const TICK_MIN = 600;
            const TICK_VAR = 900;
            const OPACITY_VISIBLE = 0.7;

            const tick = () => {
                const stars = animatedBgElementsContainer.querySelectorAll('.star');
                if (!stars.length) {
                    starTwinkleTimer = setTimeout(tick, 1000);
                    return;
                }
                const perTick = Math.max(1, Math.floor(stars.length * 0.12));
                for (let k = 0; k < perTick; k++) {
                    const idx = Math.floor(Math.random() * stars.length);
                    const star = stars[idx];
                    if (!star) continue;

                    star.style.opacity = '0';
                    const delay = 150 + Math.random() * 300;
                    setTimeout(() => {
                        const size = Math.random() * 2 + 1;
                        star.style.setProperty('--star-size', `${size}px`);
                        star.style.top = `${Math.random() * 100}%`;
                        star.style.left = `${Math.random() * 100}%`;
                        const starColors = appState.darkMode ? ['#E0E0FF', '#C4C4FF', '#A8A8FF'] : ['#CCCCFF', '#B0B0FF', '#9494FF'];
                        star.style.setProperty('--star-color', starColors[Math.floor(Math.random() * starColors.length)]);
                        star.style.opacity = String(OPACITY_VISIBLE);
                    }, delay);
                }
                starTwinkleTimer = setTimeout(tick, TICK_MIN + Math.random() * TICK_VAR);
            };

            tick();
        }
        function stopStarTwinkleLoop() {
            if (starTwinkleTimer) {
                clearTimeout(starTwinkleTimer);
                starTwinkleTimer = null;
            }
        }
        function clearAnimatedParticles(type = 'all') {
            let selector = '.star';
            if (type !== 'all') selector = `.${type}`;
            const existingParticles = animatedBgElementsContainer.querySelectorAll(selector);
            existingParticles.forEach(p => p.remove());

            if (type === 'all' || type === 'star') {
                stopStarTwinkleLoop();
            }
            if (type === 'all' || type === 'sci-fi-grid') {
                const grid = animatedBgElementsContainer.querySelector('.sci-fi-grid-overlay');
                if (grid) grid.style.opacity = '0';
            }
        }

        function addThemesMenu() {
            const themesSection = document.createElement('div');
            themesSection.className = 'mb-4';
            themesSection.innerHTML = `
                <h3 id="themes-title" class="text-lg font-medium mb-2">${t('themes')}</h3>
                <select id="theme-selector" class="w-full p-2 border rounded-md mb-2">
                    <option value="default">${t('themeDefault')}</option>
                    <option value="pastel">${t('themePastel')}</option>
                </select>
            `;
            const darkModeToggleDiv = darkModeToggleEl.closest('div');
            darkModeToggleDiv.parentNode.insertBefore(themesSection, darkModeToggleDiv.nextSibling);

            themeSelectorEl = document.getElementById('theme-selector');
            themeSelectorEl.addEventListener('change', (e) => {
                applyTheme(e.target.value);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderCurrentChapterLabel() {
            if (!currentChapterLabelEl) return;
            const ch = appState.currentChapter;
            const label = (ch === 'Tout') ? t('all') : ch;
            currentChapterLabelEl.textContent = label;
        }

        function updateLocalizedStaticTexts() {
          searchBarEl.placeholder = t('searchPlaceholder');
          const chaptersTitleEl = document.getElementById('chapters-title');
          if (chaptersTitleEl) chaptersTitleEl.textContent = t('chapters');
          const darkModeLabelEl = document.getElementById('dark-mode-label');
          if (darkModeLabelEl) darkModeLabelEl.textContent = t('darkMode');

          if (saveDataButtonEl) saveDataButtonEl.innerHTML = `<i class="fas fa-save mr-2"></i>${t('save')}`;
          const loadLabelTextEl = document.getElementById('load-data-label-text');
          if (loadLabelTextEl) loadLabelTextEl.textContent = t('load');

          const resetTitleEl = document.getElementById('reset-title');
          if (resetTitleEl) resetTitleEl.textContent = t('reset');
          if (resetDataButtonEl) resetDataButtonEl.innerHTML = `<i class="fas fa-undo mr-2"></i>${t('resetSelection')}`;

          if (reverseModeButtonEl) {
            reverseModeButtonEl.innerHTML = `<i class="fas fa-exchange-alt mr-2"></i>${t('reverseButton')}`;
          }

          const themesTitleEl = document.getElementById('themes-title');
          if (themesTitleEl) themesTitleEl.textContent = t('themes');
          if (themeSelectorEl) {
            Array.from(themeSelectorEl.options).forEach(opt => {
              if (opt.value === 'default') opt.textContent = t('themeDefault');
              if (opt.value === 'pastel') opt.textContent = t('themePastel');
            });
          }

          submitAnswerButtonEl.textContent = t('submit');

          renderChapterButtons();
          renderResetOptions();
          renderCurrentChapterLabel(); // MAJ label chapitre
        }

        function renderTimer() {
            const hours = Math.floor(appState.elapsedSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((appState.elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (appState.elapsedSeconds % 60).toString().padStart(2, '0');
            timerEl.textContent = `${hours}:${minutes}:${seconds}`;
        }

        function renderProgressBar() {
            const totalCardsInDeck = appState.currentDeck.length;
            const viewedCount = Math.min(appState.currentIndex + 1, totalCardsInDeck);

            if (totalCardsInDeck === 0) {
                progressTextEl.textContent = `${t('cardsViewed')}: 0 / 0`;
                progressPercentageEl.textContent = '0%';
                progressBarFillEl.style.width = '0%';
                return;
            }

            const percentage = Math.round((viewedCount / totalCardsInDeck) * 100);
            progressTextEl.textContent = `${t('cardsViewed')}: ${viewedCount} / ${totalCardsInDeck}`;
            progressPercentageEl.textContent = `${percentage}%`;
            progressBarFillEl.style.width = `${percentage}%`;
        }

        function getCardColorClasses(score) {
            if (score === 0) return 'bg-red-500/80 text-white dark:bg-red-800/70 dark:text-red-100';
            if (score === 16) return 'bg-red-400/80 text-white dark:bg-red-700/70 dark:text-red-100';
            if (score === 33) return 'bg-orange-400/80 text-neutral-800 dark:bg-orange-600/70 dark:text-orange-100';
            if (score === 50) return appState.darkMode ? 'dark-mode-card-neutral' : 'light-mode-card-neutral';
            if (score === 66) return 'bg-lime-400/80 text-neutral-800 dark:bg-lime-700/70 dark:text-lime-100';
            if (score === 84) return 'bg-green-500/80 text-white dark:bg-green-600/70 dark:text-green-100';
            if (score === 100) return 'bg-emerald-600/80 text-white dark:bg-emerald-700/70 dark:text-emerald-100';
            return appState.darkMode ? 'dark-mode-card-neutral' : 'light-mode-card-neutral';
        }

        let lastCardColorClass = '';
        function applyScoreClass(newCls) {
            if (lastCardColorClass) {
                flashcardContainerEl.classList.remove(...lastCardColorClass.split(' '));
            }
            flashcardContainerEl.classList.add(...newCls.split(' '));
            lastCardColorClass = newCls;
        }

        function renderCard(focusOnInput = true) {
            messageAreaEl.textContent = '';
            answerInputEl.value = '';
            appState.isCardRevealedByClick = false;
            appState.readyToAdvanceOnClick = false;

            if (appState.currentDeck.length === 0 || appState.currentIndex >= appState.currentDeck.length) {
                applyScoreClass(appState.darkMode ? 'dark-mode-card-neutral' : 'light-mode-card-neutral');
                cardFrenchWordEl.textContent = t('noCard');
                cardEnglishWordEl.textContent = '';
                cardEnglishWordEl.classList.add('hidden');
                cardScoreEl.textContent = 'N/A';
                answerInputEl.disabled = true;
                submitAnswerButtonEl.disabled = true;
                submitAnswerButtonEl.classList.add('hidden');
                return;
            }

            const card = appState.currentDeck[appState.currentIndex];
            cardFrenchWordEl.textContent = card.french;
            cardEnglishWordEl.textContent = card.english;

            const promptEl = appState.reverseMode ? cardEnglishWordEl : cardFrenchWordEl;
            const translationEl = appState.reverseMode ? cardFrenchWordEl : cardEnglishWordEl;

            promptEl.classList.remove('hidden');
            translationEl.classList.add('hidden');
            cardScoreEl.textContent = `${card.score}%`;

            const colorCls = getCardColorClasses(card.score);
            applyScoreClass(colorCls);

            answerInputEl.disabled = false;
            submitAnswerButtonEl.disabled = false;
            submitAnswerButtonEl.classList.remove('hidden');
            submitAnswerButtonEl.textContent = t('submit');
            if (focusOnInput) answerInputEl.focus({ preventScroll: true });

            renderProgressBar();
        }

        function renderChapterButtons() {
            menuChaptersContainerEl.innerHTML = '';
            const frag = document.createDocumentFragment();

            const createButton = (chapter, isMenuButton = false, isAllButton = false) => {
                const button = document.createElement('button');
                const chapterIdentifier = isAllButton ? 'Tout' : chapter.name;
                button.dataset.chapter = chapterIdentifier;
                button.innerHTML = isAllButton ? `üìö ${t('all')}` : `${chapter.emoji} ${chapter.name}`;
                button.classList.add(
                    'p-2', 'sm:p-3', 'rounded-lg', 'shadow', 'font-medium',
                    'text-xs', 'sm:text-sm', 'transition-all', 'duration-200',
                    'ease-in-out', 'hover:opacity-80', 'w-full', 'truncate'
                );

                button.addEventListener('click', () => {
                    appState.currentChapter = chapterIdentifier;
                    loadDeckForChapter(chapterIdentifier);
                    renderCurrentChapterLabel();
                    if (isMenuButton) toggleMenu(false);
                    updateActiveChapterButtonStates();
                });
                return button;
            };

            const allButtonMenu = createButton(null, true, true);
            frag.appendChild(allButtonMenu);
            chapters.forEach(chapter => frag.appendChild(createButton(chapter, true)));
            menuChaptersContainerEl.appendChild(frag);

            updateActiveChapterButtonStates();
        }

        function updateActiveChapterButtonStates() {
            const updateButtons = (container) => {
                Array.from(container.children).forEach(button => {
                    const buttonChapterName = button.dataset.chapter;
                    button.classList.remove('chapter-button-active', 'chapter-button-default');

                    if (buttonChapterName === appState.currentChapter) {
                        button.classList.add('chapter-button-active');
                    } else {
                        button.classList.add('chapter-button-default');
                    }

                    const buttonFontFamily = getComputedStyle(document.body).fontFamily;
                    button.style.fontFamily = buttonFontFamily;
                });
            };
            updateButtons(menuChaptersContainerEl);
        }

        function renderResetOptions() {
            resetOptionsEl.innerHTML = `<option value="Tout">${t('all')}</option>`;
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.name;
                option.textContent = chapter.name;
                resetOptionsEl.appendChild(option);
            });
        }

        // --- LOGIC FUNCTIONS ---
        function startTimer() {
            if (appState.timerInterval) clearInterval(appState.timerInterval);
            appState.timerInterval = setInterval(() => {
                appState.elapsedSeconds++;
                renderTimer();
            }, 1000);
        }

        function loadDeckForChapter(chapterName) {
            appState.currentChapter = chapterName;
            if (chapterName === 'Tout') {
                appState.currentDeck = [...appState.allCards];
            } else {
                appState.currentDeck = appState.allCards.filter(card => card.chapter === chapterName);
            }
            appState.currentIndex = 0;
            appState.seenCountInSession = 0;
            shuffleAndSortDeck();
            renderCurrentChapterLabel();
            updateActiveChapterButtonStates();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function shuffleAndSortDeck() {
            let cardsToProcess;
            if (appState.currentChapter === 'Tout') {
                cardsToProcess = [...appState.allCards];
            } else {
                cardsToProcess = appState.allCards.filter(card => card.chapter === appState.currentChapter);
            }

            shuffleArray(cardsToProcess);
            cardsToProcess.sort((a, b) => a.score - b.score);

            appState.currentDeck = cardsToProcess;
            appState.currentIndex = 0;
            appState.seenCountInSession = 0;
            renderCard(false);
            renderProgressBar();
        }

        function handleAnswer(isCorrect) {
            if (appState.currentDeck.length === 0) return;
            const card = appState.currentDeck[appState.currentIndex];
            appState.isCardRevealedByClick = false;

            let currentScoreIndex = scoreLevels.indexOf(card.score);
            if (currentScoreIndex === -1) {
                card.score = 50;
                currentScoreIndex = scoreLevels.indexOf(50);
            }

            if (isCorrect) {
                messageAreaEl.textContent = t('correct');
                messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-emerald-500 dark:text-emerald-400';
                if (currentScoreIndex < scoreLevels.length - 1) {
                    card.score = scoreLevels[currentScoreIndex + 1];
                }
            } else {
                messageAreaEl.textContent = t('incorrect');
                messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-red-500 dark:text-red-400';
                if (currentScoreIndex > 0) {
                    card.score = scoreLevels[currentScoreIndex - 1];
                }
                const translationEl = appState.reverseMode ? cardFrenchWordEl : cardEnglishWordEl;
                translationEl.classList.remove('hidden');
            }

            const masterCardIndex = appState.allCards.findIndex(c => c.id === card.id);
            if (masterCardIndex !== -1) {
                appState.allCards[masterCardIndex].score = card.score;
            }

            cardScoreEl.textContent = `${card.score}%`;
            const colorCls = getCardColorClasses(card.score);
            applyScoreClass(colorCls);

            answerInputEl.disabled = true;
            submitAnswerButtonEl.classList.add('hidden');
            appState.readyToAdvanceOnClick = true;
        }

        function nextCard() {
            appState.currentIndex++;
            appState.seenCountInSession++;
            messageAreaEl.textContent = '';

            if (appState.currentIndex >= appState.currentDeck.length) {
                messageAreaEl.textContent = t('endOfDeck');
                messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-sky-500 dark:text-sky-400';
                requestAnimationFrame(() => shuffleAndSortDeck());
            } else {
                renderCard();
            }
            renderProgressBar();
        }

        function toggleMenu(forceOpen) {
            if (forceOpen === true || !sidebarMenuEl.classList.contains('menu-slide-in')) {
                sidebarMenuEl.classList.remove('menu-slide-out');
                sidebarMenuEl.classList.add('menu-slide-in');
            } else {
                sidebarMenuEl.classList.remove('menu-slide-in');
                sidebarMenuEl.classList.add('menu-slide-out');
            }
        }

        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.documentElement.classList.toggle('dark', appState.darkMode);
            document.body.classList.toggle('dark-mode', appState.darkMode);
            document.body.classList.toggle('light-mode', !appState.darkMode);
            darkModeToggleEl.innerHTML = appState.darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('flashcardAppDarkMode', String(appState.darkMode));
            applyTheme(appState.currentTheme);
        }

        function saveData() {
            const dataToSave = {
                allCards: appState.allCards,
                elapsedSeconds: appState.elapsedSeconds,
                currentChapter: appState.currentChapter,
                darkMode: appState.darkMode,
                currentTheme: appState.currentTheme,
                reverseMode: appState.reverseMode
            };
            const jsonData = JSON.stringify(dataToSave);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'flashcard_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            messageAreaEl.textContent = t('dataSaved');
            messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-green-500 dark:text-green-400';
            setTimeout(() => messageAreaEl.textContent = '', 2000);
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        appState.allCards = (loadedData.allCards || initialCardsData).map(c => {
                            const score = scoreLevels.includes(c.score) ? c.score : 50;
                            return { ...c, score };
                        });
                        appState.elapsedSeconds = loadedData.elapsedSeconds || 0;
                        appState.currentChapter = loadedData.currentChapter || 'Tout';

                        if (typeof loadedData.darkMode === 'boolean') {
                            appState.darkMode = loadedData.darkMode;
                        } else {
                            const savedDarkModePreference = localStorage.getItem('flashcardAppDarkMode');
                            appState.darkMode = savedDarkModePreference === 'true';
                        }
                        document.documentElement.classList.toggle('dark', appState.darkMode);
                        document.body.classList.toggle('dark-mode', appState.darkMode);
                        document.body.classList.toggle('light-mode', !appState.darkMode);
                        darkModeToggleEl.innerHTML = appState.darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                        localStorage.setItem('flashcardAppDarkMode', String(appState.darkMode));

                        appState.currentTheme = loadedData.currentTheme || 'default';
                        if (appState.currentTheme === 'galaxy') appState.currentTheme = 'default';
                        if (themeSelectorEl) themeSelectorEl.value = appState.currentTheme;
                        applyTheme(appState.currentTheme);

                        appState.reverseMode = !!loadedData.reverseMode;
                        updateUIForReverseMode();

                        buildSearchIndex();
                        renderTimer();
                        loadDeckForChapter(appState.currentChapter);
                        renderChapterButtons();
                        renderResetOptions();
                        renderCurrentChapterLabel();

                        messageAreaEl.textContent = t('dataLoaded');
                        messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-green-500 dark:text-green-400';
                    } catch (error) {
                        console.error('Error loading data:', error);
                        messageAreaEl.textContent = t('dataLoadError');
                        messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-red-500 dark:text-red-400';
                    } finally {
                        loadDataInputEl.value = '';
                        setTimeout(() => messageAreaEl.textContent = '', 2000);
                    }
                };
                reader.readAsText(file);
            }
        }

        function resetData() {
            const chapterToReset = resetOptionsEl.value;
            const confirmReset = confirm(tr('resetConfirm', { chapter: chapterToReset }));
            if (!confirmReset) return;

            appState.allCards.forEach(card => {
                if (chapterToReset === 'Tout' || card.chapter === chapterToReset) {
                    card.score = 50;
                }
            });

            if (chapterToReset === 'Tout' || chapterToReset === appState.currentChapter) {
                loadDeckForChapter(appState.currentChapter);
            } else {
                if (appState.currentDeck.length > 0 && appState.currentIndex < appState.currentDeck.length) {
                    const currentCardInNewDeck = appState.currentDeck[appState.currentIndex];
                    const masterCardIndex = appState.allCards.findIndex(c => c.id === currentCardInNewDeck.id);
                    if (masterCardIndex !== -1) {
                        appState.currentDeck[appState.currentIndex].score = appState.allCards[masterCardIndex].score;
                        renderCard();
                    }
                }
            }
            messageAreaEl.textContent = tr('resetDone', { chapter: chapterToReset });
            messageAreaEl.className = 'w-full text-center h-6 text-sm font-medium text-orange-500 dark:text-yellow-400';
            setTimeout(() => messageAreaEl.textContent = '', 3000);
        }

        // --- RECHERCHE: index + debounce ---
        function buildSearchIndex() {
            appState.searchIndex = appState.allCards.map(c => ({
                id: c.id,
                french_lc: c.french.toLowerCase(),
                english_lc: c.english.toLowerCase(),
                chapter: c.chapter,
                ref: c
            }));
        }

        function filterCardsForSearch(query) {
            searchResultsContainerEl.innerHTML = '';
            const q = query.trim().toLowerCase();
            if (!q) return;

            const results = [];
            const idx = appState.searchIndex || [];
            for (let i = 0; i < idx.length && results.length < 5; i++) {
                const c = idx[i];
                if (c.french_lc.includes(q) || c.english_lc.includes(q)) {
                    results.push(c.ref);
                }
            }

            if (results.length === 0) {
                searchResultsContainerEl.innerHTML = `<p class="p-2">${t('noResult')}</p>`;
                return;
            }

            const frag = document.createDocumentFragment();
            for (const card of results) {
                const item = document.createElement('div');
                item.className = `p-2 cursor-pointer rounded ${appState.darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`;
                item.textContent = `${card.french} - ${card.english} (${card.chapter})`;
                item.addEventListener('click', () => {
                    appState.currentChapter = card.chapter;
                    loadDeckForChapter(card.chapter);
                    const idxInDeck = appState.currentDeck.findIndex(c => c.id === card.id);
                    appState.currentIndex = idxInDeck !== -1 ? idxInDeck : 0;
                    renderCard(false);
                    renderProgressBar();
                    toggleMenu(false);
                    searchBarEl.value = '';
                    searchResultsContainerEl.innerHTML = '';
                    updateActiveChapterButtonStates();
                    renderCurrentChapterLabel();
                });
                frag.appendChild(item);
            }
            searchResultsContainerEl.appendChild(frag);
        }

        // --- EVENT LISTENERS ---
        flashcardContainerEl.addEventListener('click', () => {
            if (appState.currentDeck.length === 0) return;
            if (appState.readyToAdvanceOnClick) {
                nextCard();
                return;
            }
            const translationEl = appState.reverseMode ? cardFrenchWordEl : cardEnglishWordEl;
            if (translationEl.classList.contains('hidden')) {
                translationEl.classList.remove('hidden');
                appState.isCardRevealedByClick = true;
                appState.readyToAdvanceOnClick = true;
                answerInputEl.disabled = true;
                submitAnswerButtonEl.classList.add('hidden');
            }
        });

        submitAnswerButtonEl.addEventListener('click', () => {
            if (answerInputEl.disabled) return;
            const userAnswer = answerInputEl.value.trim().toLowerCase();
            if (!userAnswer) return;

            function validateAnswer(userAnswer, correctAnswerFull) {
                const userNormalized = userAnswer.replace(/\s+/g, ' ').trim().toLowerCase();
                const correctNormalized = correctAnswerFull.replace(/\s+/g, ' ').trim().toLowerCase();

                if (userNormalized === correctNormalized) return true;

                if (correctNormalized.includes('/')) {
                    const alternatives = correctNormalized.split('/').map(alt => alt.trim());
                    if (alternatives.includes(userNormalized)) return true;
                }

                const articlesToIgnore = ['a', 'an', 'the', 'un', 'une', 'des', 'le', 'la', 'les', "l'"];
                const userMainWords = userNormalized.split(/\s+/).filter(word => !articlesToIgnore.includes(word)).join(' ');
                const correctMainWords = correctNormalized.split(/\s+/).filter(word => !articlesToIgnore.includes(word)).join(' ');
                if (userMainWords === correctMainWords && userMainWords.length > 0) return true;

                const userNoHyphen = userNormalized.replace(/-/g, ' ');
                const correctNoHyphen = correctNormalized.replace(/-/g, ' ');
                if (userNoHyphen === correctNoHyphen) return true;

                const lenDiff = Math.abs(userNormalized.length - correctNormalized.length);
                if (userNormalized.length < 4 || lenDiff > 3) {
                    return false;
                }

                function calculateSimilarity(str1, str2) {
                    if (!str1 || !str2) return 0;
                    const matrix = Array(str1.length + 1).fill(null).map(() =>
                        Array(str2.length + 1).fill(null)
                    );
                    for (let i = 0; i <= str1.length; i += 1) matrix[i][0] = i;
                    for (let j = 0; j <= str2.length; j += 1) matrix[0][j] = j;
                    for (let i = 1; i <= str1.length; i += 1) {
                        for (let j = 1; j <= str2.length; j += 1) {
                            const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j - 1] + cost
                            );
                        }
                    }
                    const maxLen = Math.max(str1.length, str2.length);
                    return maxLen === 0 ? 1 : 1 - (matrix[str1.length][str2.length] / maxLen);
                }
                const similarity = calculateSimilarity(userNormalized, correctNormalized);
                return similarity > 0.85;
            }

            const correctAnswerFull = (appState.reverseMode
                ? appState.currentDeck[appState.currentIndex].french
                : appState.currentDeck[appState.currentIndex].english).trim();
            const isCorrect = validateAnswer(userAnswer, correctAnswerFull.toLowerCase());
            handleAnswer(isCorrect);
        });

        answerInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                if (!answerInputEl.disabled) {
                    submitAnswerButtonEl.click();
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.activeElement !== answerInputEl && document.activeElement !== searchBarEl) {
                e.preventDefault();
                if (appState.readyToAdvanceOnClick) {
                    nextCard();
                } else if (appState.currentDeck.length > 0) {
                    const translationEl = appState.reverseMode ? cardFrenchWordEl : cardEnglishWordEl;
                    if (translationEl.classList.contains('hidden')) {
                        translationEl.classList.remove('hidden');
                        appState.isCardRevealedByClick = true;
                        appState.readyToAdvanceOnClick = true;
                        answerInputEl.disabled = true;
                        submitAnswerButtonEl.classList.add('hidden');
                    }
                }
            }
        });

        reverseModeButtonEl.addEventListener('click', () => {
            appState.reverseMode = !appState.reverseMode;
            updateUIForReverseMode();
            renderCard(false);
            renderCurrentChapterLabel();
        });

        burgerButtonEl.addEventListener('click', () => toggleMenu(true));
        closeMenuButtonEl.addEventListener('click', () => toggleMenu(false));
        darkModeToggleEl.addEventListener('click', toggleDarkMode);
        saveDataButtonEl.addEventListener('click', saveData);
        loadDataInputEl.addEventListener('change', loadData);
        resetDataButtonEl.addEventListener('click', resetData);

        // Debounce pour la recherche
        let searchDebounceId;
        searchBarEl.addEventListener('input', (e) => {
            const q = e.target.value;
            clearTimeout(searchDebounceId);
            searchDebounceId = setTimeout(() => filterCardsForSearch(q), 150);
        });

        // Ferme le menu si clic √† l'ext√©rieur
        document.addEventListener('click', (e) => {
            const isMenuOpen = sidebarMenuEl.classList.contains('menu-slide-in');
            const isClickInsideMenu = sidebarMenuEl.contains(e.target);
            const isClickOnBurgerButton = burgerButtonEl.contains(e.target);
            if (isMenuOpen && !isClickInsideMenu && !isClickOnBurgerButton) {
                toggleMenu(false);
            }
        });

        // --- SWIPE MOBILE: ouvrir/fermer le menu ---
        let touchStartX = null;
        let touchStartY = null;
        function isSmallScreen() {
            return window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
        }
        function onTouchStart(e) {
            if (!isSmallScreen() || e.touches.length !== 1) return;
            const t = e.touches[0];
            touchStartX = t.clientX;
            touchStartY = t.clientY;
        }
        function onTouchEnd(e) {
            if (!isSmallScreen() || touchStartX === null || e.changedTouches.length !== 1) return;
            const t = e.changedTouches[0];
            const dx = t.clientX - touchStartX;
            const dy = t.clientY - touchStartY;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);
            const isHorizontal = absDx > 60 && absDx > absDy;
            const isMenuOpen = sidebarMenuEl.classList.contains('menu-slide-in');

            if (!isHorizontal) {
                touchStartX = touchStartY = null;
                return;
            }

            // Slide droite => ouvrir (si d√©marr√© au bord gauche et menu ferm√©)
            if (dx > 0) {
                if (!isMenuOpen && touchStartX <= 30) {
                    toggleMenu(true);
                }
            } else {
                // Slide gauche => fermer si ouvert
                if (isMenuOpen) toggleMenu(false);
            }

            touchStartX = touchStartY = null;
        }
        document.addEventListener('touchstart', onTouchStart, { passive: true });
        document.addEventListener('touchend', onTouchEnd, { passive: true });

        // --- INITIALIZATION ---
        function initializeApp() {
            const savedDarkModePreference = localStorage.getItem('flashcardAppDarkMode');
            appState.darkMode = savedDarkModePreference === 'true';

            document.documentElement.classList.toggle('dark', appState.darkMode);
            document.body.classList.toggle('dark-mode', appState.darkMode);
            document.body.classList.toggle('light-mode', !appState.darkMode);

            darkModeToggleEl.innerHTML = appState.darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

            addThemesMenu();

            let savedTheme = localStorage.getItem('flashcardAppTheme') || 'default';
            if (savedTheme === 'galaxy') savedTheme = 'default';
            appState.currentTheme = savedTheme;
            if (themeSelectorEl) themeSelectorEl.value = appState.currentTheme;

            appState.allCards = initialCardsData.map(c => ({ ...c }));

            buildSearchIndex();
            applyTheme(appState.currentTheme);
            updateUIForReverseMode();
            updateLocalizedStaticTexts();

            renderChapterButtons();
            renderResetOptions();
            loadDeckForChapter(appState.currentChapter);
            renderCurrentChapterLabel();

            startTimer();
            renderTimer();
        }

        initializeApp();
    </script>
</body>
</html>
