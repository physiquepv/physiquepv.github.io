<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diff → Code</title>
  <style>
    :root{
      --bg:#0f1226; --panel:#141735; --text:#eef1ff; --muted:#98a2ff;
      --accent:#7c91ff; --ok:#00d28a; --err:#ff6b6b; --border:#242953;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
         background:var(--bg); color:var(--text)}
    header{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px}
    h1{margin:0; font-size:16px}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--ok); opacity:.8}
    .wrap{display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:12px}
    .panel{display:flex; flex-direction:column; background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden; min-height: 280px;}
    .panel header{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid var(--border)}
    .panel h2{font-size:13px; margin:0}
    textarea{
      width:100%; height:300px; flex:1; background:transparent; color:var(--text);
      border:0; padding:10px; resize:vertical; font: 13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      outline:none; tab-size:2; caret-color:var(--accent);
    }
    .controls{display:flex; gap:8px; padding:0 12px 12px; justify-content:flex-end}
    button{
      appearance:none; border:1px solid var(--border); background:#1a1f4a; color:#e8eaff;
      padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;
    }
    button.primary{background:linear-gradient(135deg,#6f86ff,#8f6fff); border:0}
    button:disabled{opacity:0.5; cursor:not-allowed}
    .status{padding:8px 12px; font-size:12px; border-top:1px solid var(--border); color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}
    .result{margin:0 12px 12px; background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden}
    .result header{padding:8px 10px; border-bottom:1px solid var(--border)}
    .badge{background:#21265a; color:#cbd1ff; padding:2px 8px; border-radius:999px; font-size:11px}
  </style>
</head>
<body>
  <header>
    <div class="dot" title="Autosauvegarde active"></div>
    <h1>Diff → Code</h1>
  </header>

  <div class="wrap">
    <section class="panel">
      <header><h2>Code</h2><span class="badge">Entrée</span></header>
      <textarea id="code" placeholder="Collez votre code…"></textarea>
    </section>

    <section class="panel">
      <header><h2>Diff</h2><span class="badge">+/-</span></header>
      <textarea id="diff" placeholder="Collez un diff unifié (git)…"></textarea>
    </section>
  </div>

  <div class="controls">
    <button id="example" type="button">Exemple</button>
    <button id="undo" type="button" disabled>↶ Retour (Ctrl+Z)</button>
    <button id="execute" type="button">▶ Exécuter le résultat</button>
    <button id="apply" class="primary" type="button">Appliquer + Copier</button>
  </div>

  <section class="result">
    <header><strong>Résultat</strong></header>
    <textarea id="result" placeholder="Code modifié…" readonly></textarea>
    <div id="status" class="status">Prêt</div>
  </section>

  <section class="result" id="preview-section" style="display:none">
    <header>
      <strong>Prévisualisation / Exécution</strong>
      <button id="clear-preview" type="button" style="padding:4px 8px;font-size:11px">✕ Fermer</button>
    </header>
    <div style="padding:12px; max-height:400px; overflow:auto">
      <pre id="preview" style="margin:0;color:var(--text);font-size:13px;line-height:1.6;white-space:pre-wrap"></pre>
    </div>
  </section>

  <script type="module">
    import { applyPatch } from 'https://esm.sh/diff@5?bundle';

    const codeEl = document.getElementById('code');
    const diffEl = document.getElementById('diff');
    const outEl  = document.getElementById('result');
    const statusEl = document.getElementById('status');
    const applyBtn = document.getElementById('apply');
    const undoBtn = document.getElementById('undo');
    const executeBtn = document.getElementById('execute');
    const previewSection = document.getElementById('preview-section');
    const previewEl = document.getElementById('preview');
    const exampleBtn = document.getElementById('example');

    const LS_STATE = 'diff-lite:v1:state';
    const LS_UNDO_STACK = 'diff-lite:v1:undoStack';
    const MAX_UNDO = 50;
    const MAX_HISTORY = 20;

    const now = () => new Date().toISOString();

    function setStatus(msg, kind='') {
      statusEl.className = 'status ' + (kind || '');
      statusEl.textContent = msg;
    }

    function cleanupPatch(raw) {
      if (!raw) return '';
      let s = raw.trim();
      if (s.startsWith('```')) {
        s = s.replace(/^```(?:diff|patch)?\s*/i, '');
        s = s.replace(/\s*```$/i, '');
      }
      return s;
    }

    // === UNDO Stack ===
    let undoStack = [];

    function loadUndoStack() {
      try {
        const raw = localStorage.getItem(LS_UNDO_STACK);
        undoStack = raw ? JSON.parse(raw) : [];
      } catch (e) {
        undoStack = [];
      }
      updateUndoButton();
    }

    function saveUndoStack() {
      try {
        localStorage.setItem(LS_UNDO_STACK, JSON.stringify(undoStack));
      } catch (e) {
        console.warn('Undo stack save error:', e);
      }
    }

    function pushUndo() {
      const snapshot = {
        code: codeEl.value ?? '',
        diff: diffEl.value ?? '',
        result: outEl.value ?? '',
        ts: Date.now()
      };
      undoStack.push(snapshot);
      while (undoStack.length > MAX_UNDO) undoStack.shift();
      saveUndoStack();
      updateUndoButton();
    }

    function updateUndoButton() {
      undoBtn.disabled = undoStack.length === 0;
    }

    // === State persistence ===
    function saveState(extra={}) {
      try {
        const state = {
          code: codeEl.value ?? '',
          diff: diffEl.value ?? '',
          result: outEl.value ?? '',
          ts: Date.now(),
          ...extra
        };
        localStorage.setItem(LS_STATE, JSON.stringify(state));
        return state;
      } catch (e) {
        console.warn('Save error:', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_STATE);
        if (!raw) return false;
        const s = JSON.parse(raw);
        codeEl.value = s.code ?? '';
        diffEl.value = s.diff ?? '';
        outEl.value  = s.result ?? '';
        setStatus('Rechargé', 'ok');
        return true;
      } catch (e) {
        console.warn('Load error:', e);
        return false;
      }
    }

    function performUndo() {
      if (undoStack.length === 0) {
        setStatus('Aucun historique', 'err');
        return;
      }
      
      const snapshot = undoStack.pop();
      codeEl.value = snapshot.code ?? '';
      diffEl.value = snapshot.diff ?? '';
      outEl.value = snapshot.result ?? '';
      
      saveState({ reason: 'undo' });
      saveUndoStack();
      updateUndoButton();
      
      const count = undoStack.length;
      setStatus(`Annulé (${count} dans l'historique)`, 'ok');
    }

    // === Backup system ===
    function backupSnapshot(reason='auto') {
      try {
        const snap = {
          code: codeEl.value ?? '',
          diff: diffEl.value ?? '',
          result: outEl.value ?? '',
          at: now(),
          reason
        };
        const list = [];  // Optionnel : garder l'ancien système ou le supprimer
        list.push(snap);
        while (list.length > MAX_HISTORY) list.shift();
        localStorage.setItem(LS_HISTORY, JSON.stringify(list));
      } catch (e) {
        console.warn('Backup error:', e);
      }
    }

    let saveTimer = null;
    function scheduleSave(reason='typing') {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveState({ reason });
        // backup léger (toutes les 5s max)
      }, 400);
    }

    // Throttle backups à ~5s pour éviter d’inonder
    let lastBackup = 0;
    function maybeBackup(reason='typing') {
      const t = Date.now();
      if (t - lastBackup > 5000) {
        lastBackup = t;
        backupSnapshot(reason);
      }
    }

    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          outEl.removeAttribute('readonly');
          outEl.focus();
          outEl.select();
          document.execCommand('copy');
          outEl.setAttribute('readonly', 'readonly');
        }
        return true;
      } catch (e) {
        console.warn('Clipboard error:', e);
        return false;
      }
    }

    async function applyDiff() {
      const original = codeEl.value ?? '';
      let patch = cleanupPatch(diffEl.value ?? '');

      // Sauvegarder l'état actuel avant d'appliquer
      pushUndo();

      if (!original.trim()) {
        setStatus('Code manquant', 'err'); codeEl.focus(); return;
      }
      if (!patch.trim()) {
        setStatus('Diff manquant', 'err'); diffEl.focus(); return;
      }

      try {
        const patched = applyPatch(original, patch);
        if (patched === false || typeof patched !== 'string') {
          setStatus('Diff invalide', 'err'); return;
        }
        outEl.value = patched;

        // **NOUVEAU : Remplacer le code original par le code modifié**
        codeEl.value = patched;

        // Sauvegarde + backup
        saveState({ reason: 'apply' });
        backupSnapshot('apply');

        const ok = await copyToClipboard(patched);
        setStatus(ok ? 'Copié ✓' : 'Appliqué (copie refusée)', ok ? 'ok' : 'err');
      } catch (err) {
        console.error(err);
        setStatus('Erreur patch', 'err');
      }
    }

    function executeCode() {
      const code = outEl.value?.trim();
      
      if (!code) {
        setStatus('Aucun résultat à exécuter', 'err');
        return;
      }

      previewSection.style.display = 'block';
      previewEl.textContent = '⏳ Exécution...\n';

      // Petit délai pour l'affichage
      setTimeout(() => {
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        // Intercepter console.log
        console.log = (...args) => {
          logs.push(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' '));
          originalLog(...args);
        };
        console.error = (...args) => {
          logs.push('❌ ' + args.map(a => String(a)).join(' '));
          originalError(...args);
        };
        console.warn = (...args) => {
          logs.push('⚠️ ' + args.map(a => String(a)).join(' '));
          originalWarn(...args);
        };

        try {
          const result = eval(code);
          if (result !== undefined) {
            logs.push('→ ' + (typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result)));
          }
          previewEl.textContent = logs.length > 0 ? logs.join('\n') : '✓ Exécution réussie (aucune sortie)';
          setStatus('Code exécuté ✓', 'ok');
        } catch (err) {
          logs.push('\n❌ ERREUR:\n' + err.toString());
          if (err.stack) logs.push('\n' + err.stack);
          previewEl.textContent = logs.join('\n');
          setStatus('Erreur d\'exécution', 'err');
        } finally {
          console.log = originalLog;
          console.error = originalError;
          console.warn = originalWarn;
        }
      }, 50);
    }

    // Listeners
    applyBtn.addEventListener('click', applyDiff);
    undoBtn.addEventListener('click', performUndo);
    executeBtn.addEventListener('click', executeCode);

    document.getElementById('clear-preview').addEventListener('click', () => {
      previewSection.style.display = 'none';
      previewEl.textContent = '';
    });

    document.addEventListener('keydown', (e) => {
      const isEnterCombo = (e.key === 'Enter' && (e.ctrlKey || e.metaKey));
      const isUndo = (e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey) && !e.shiftKey;
      const isExecute = (e.key === 'e' || e.key === 'E') && (e.ctrlKey || e.metaKey) && e.shiftKey;
      
      if (isUndo) {
        e.preventDefault();
        performUndo();
        return;
      }

      if (isExecute) {
        e.preventDefault();
        executeCode();
        return;
      }
      
      if (isEnterCombo) {
        e.preventDefault();
        applyDiff();
      }
    });

    codeEl.addEventListener('input', () => { scheduleSave('typing-code'); maybeBackup('typing-code'); });
    diffEl.addEventListener('input', () => { scheduleSave('typing-diff'); maybeBackup('typing-diff'); });

    exampleBtn.addEventListener('click', () => {
      const sampleCode =
`function greet(name) {
  return "Hello, " + name + "!";
}
`;
      const samplePatch =
`--- a/file.js
+++ b/file.js
@@ -1,3 +1,3 @@
-function greet(name) {
-  return "Hello, " + name + "!";
-}
+function greet(name = "le monde") {
+  return "Bonjour, " + name + "!";
+}
`;
      codeEl.value = sampleCode;
      diffEl.value = samplePatch;
      outEl.value = '';
      setStatus('Exemple', 'ok');
      pushUndo();
      saveState({ reason: 'example' });
      backupSnapshot('example');
    });

    // Sauvegarde à la fermeture
    window.addEventListener('beforeunload', () => {
      saveState({ reason: 'unload' });
      backupSnapshot('unload');
    });

    // Chargement initial
    const hadState = loadState();
    if (!hadState) setStatus('Prêt');
    loadUndoStack();

  </script>
</body>
</html>